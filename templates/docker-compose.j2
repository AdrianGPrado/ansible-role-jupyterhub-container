jpydb:
    image: postgres
    restart: always
    environment:
      POSTGRES_DB: jupyterhub
      POSTGRES_PASSWORD: "{{ jpy_postgres_password }}"
      PGDATA: /var/lib/postgresql/data/jupyterhub
    volumes:
      - /srv/postgres/jupyterhub:/var/lib/postgresql/data/jupyterhub

jupyterhub:
    build: /srv/jupyterhub
    restart: always
    environment:
      JPY_COOKIE_SECRET: "{{ cookie_secret }}"
      JPY_DB_USER: postgres
      JPY_DB_PASSWORD: "{{ jpy_postgres_password }}"
      JPY_DB_NAME: jupyterhub
      CONFIGPROXY_AUTH_TOKEN: "{{ configproxy_auth_token }}"
{#       DOCKER_TLS_CERT: "{{ docker_tls_path }}/cert.pem" #}
{#       DOCKER_TLS_KEY: "{{ docker_tls_path }}/key.pem" #}
{#       HUB_IP: "{{ servicenet_ip }}" #}
      HUB_IP: "{{ ansible_ssh_host }}"
    volumes:
      - /srv/jupyterhub_users:/srv/jupyterhub_users
{#       - "{{ docker_tls_path }}:{{ docker_tls_path }}" #}
{#       - /var/run/restuser.sock:/restuser.sock #}
    ports:
      - "{# {{ servicenet_ip }} #}:8000:8000"
      - "{# {{ servicenet_ip }} #}:8081:8081"
    links:
      - jpydb:postgres

cull:
    build: /srv/cull
    restart: always
    command: --timeout=86400 --cull_every=3600 --url=http://jupyterhub:8081/hub
    environment:
      JPY_API_TOKEN:
    links:
      - jupyterhub

stats:
    build: /srv/stats
    restart: always
    command: --file=/srv/stats_db/activity.sqlite --hub=http://jupyterhub:8081
    environment:
      JPY_API_TOKEN:
    volumes:
      - /srv/stats_db:/srv/stats_db
    links:
      - jupyterhub
